#Clone https://github.com/chrismeyersfsu/provision_docker.git to /etc/ansible/roles before run
---
- name: "Bring up docker containers for docker connection inventory"
  hosts: localhost
  roles:
    - role: provision_docker
      provision_docker_privileged: true,
      provision_docker_inventory_group: "{{ groups['robots'] }}"
      provision_docker_use_docker_connection: true

- hosts: robots
  vars:
    ca:
      local_dir: /tmp/ansible-ca
      remote_dir: /etc/ssl
      cert_file: ca.pem
      key_file: ca.key
      csr_file: ca.csr
      country_name: US
      organization_name: Example
      email_address: ca@example.com
      common_name: ca
  tasks:
    - name: "Say hello to my new containers"
      ping:

    - name: "Create directories for local CA files"
      local_action:
        module: file
        path: "{{ ca.local_dir }}"
        state: directory
        mode: 0755

    - name: "Generate an OpenSSL private key with the default values (4096 bits, RSA) for local CA"
      local_action:
        module: openssl_privatekey
        path: "{{ ca.local_dir }}/{{ ca.key_file }}"

    - name: "Generate an OpenSSL Certificate Signing Request with Subject information for local CA"
      local_action:
        module: openssl_csr
        path: "{{ ca.local_dir }}/{{ ca.csr_file }}"
        privatekey_path: "{{ ca.local_dir }}/{{ ca.key_file }}"
        country_name: "{{ ca.country_name }}"
        organization_name: "{{ ca.organization_name }}"
        email_address: "{{ ca.email_address }}"
        common_name: "{{ ca.common_name }}"
        basic_constraints: "CA:true"

    - name: "Generate a Self Signed local CA certificate"
      local_action:
        module: openssl_certificate
        path: "{{ ca.local_dir }}/{{ ca.cert_file }}"
        privatekey_path: "{{ ca.local_dir }}/{{ ca.key_file }}"
        csr_path: "{{ ca.local_dir }}/{{ ca.csr_file }}"
        provider: selfsigned

    - name: "Copy CA file to remote location"
      copy:
        src: /tmp/ansible/etc/ssl/crt/ca.crt
        dest: /etc/ssl/

    - name: "Install required pip packages"
      pip:
        name:
          - pyOpenSSL

    - name: "Create directories"
      file:
        path: /etc/ssl/{{ item.dir }}
        state: directory
        mode: 0755
      with_items:
        - { dir: 'csr' }
        - { dir: 'crt' }
        - { dir: 'private' }


    # Testing original crypto modules

    - name: "Generate an OpenSSL private key with the default values (4096 bits, RSA)"
      openssl_privatekey:
        path: /etc/ssl/private/ansible.com.pem

    - name: "Generate an OpenSSL Certificate Signing Request with Subject information"
      openssl_csr:
        path: /etc/ssl/csr/www.ansible.com.csr
        privatekey_path: /etc/ssl/private/ansible.com.pem
        country_name: FR
        organization_name: Ansible
        email_address: jdoe@ansible.com
        common_name: www.ansible.com

    - name: "Generate a Self Signed OpenSSL certificate"
      openssl_certificate:
        path: /etc/ssl/crt/www.ansible.com.crt
        privatekey_path: /etc/ssl/private/ansible.com.pem
        csr_path: /etc/ssl/csr/www.ansible.com.csr
        provider: selfsigned